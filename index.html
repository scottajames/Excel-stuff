<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>PSOP Connect - Excel Transformer with Preview</title>
<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
<style>
body{font-family:Calibri, sans-serif;background:#f5f5f5;margin:0;padding:20px;color:#222}
.container{max-width:1200px;margin:0 auto}
h1{font-size:22px;margin-bottom:20px}
h2{font-size:18px;color:#217346;margin:25px 0 15px 0;padding-bottom:8px;border-bottom:2px solid #217346}
.upload-area{border:2px dashed #217346;padding:40px;text-align:center;background:white;border-radius:6px;color:#217346;cursor:pointer;font-weight:bold;margin-bottom:20px;transition:all 0.3s ease}
.upload-area:hover{background:#e6f2e6}
.upload-area.processing{opacity:0.7;cursor:wait}
button{padding:10px 14px;border:none;border-radius:4px;background:#217346;color:#fff;cursor:pointer;font-size:16px;margin-bottom:20px;display:none;transition:background 0.3s ease}
button:hover{background:#1a5a2f}
button:disabled{background:#cccccc;cursor:not-allowed}
table{border-collapse:collapse;margin-top:10px;width:100%;font-family:Calibri,sans-serif;font-size:14px;table-layout:fixed;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
th,td{border:1px solid #999;padding:6px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;text-align:left}
th{background:#217346;color:#fff;font-weight:bold;text-align:center;position:sticky;top:0;z-index:10}
.preview-section{margin-top:30px}
.unit-status {margin-bottom: 20px; padding: 12px; border-radius: 4px; transition: all 0.3s ease;}
.unit-status.loaded {background-color: #ccffcc; border: 1px solid #217346;}
.unit-status.not-loaded {background-color: #ffcccc; border: 1px solid #ff0000;}
.manual-upload-area {border: 2px dashed #ff9900; padding: 20px; text-align: center; background: white; border-radius: 6px; color: #ff9900; cursor: pointer; font-weight: bold; margin-bottom: 20px; display: none; transition: all 0.3s ease;}
.manual-upload-area:hover {background: #fff9e6;}
.manual-upload-area.loaded {border-color: #217346; color: #217346;}
.stats-container {display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;}
.stat-box {background: white; padding: 15px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); min-width: 200px; flex: 1;}
.stat-title {font-weight: bold; color: #666; font-size: 14px; margin-bottom: 5px;}
.stat-value {font-size: 24px; color: #217346; font-weight: bold;}
.loading {display: none; text-align: center; padding: 20px;}
.loading-spinner {border: 4px solid #f3f3f3; border-top: 4px solid #217346; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px;}
@keyframes spin {0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }}
.row-count {font-size: 12px; color: #666; margin-top: 10px; font-style: italic;}
.error-row {background-color: #ffebee !important;}
.warning-row {background-color: #fff3e0 !important;}
.success-row {background-color: #e8f5e9 !important;}
.validation-info {background-color: #e3f2fd; padding: 10px; border-radius: 4px; margin: 10px 0; font-size: 14px;}
.validation-info strong {color: #1976d2;}
</style>
</head>
<body>
<div class="container">
  <h1>MBS - DUT & Security Mapping tool</h1>

<!-- Loading indicator -->
<div id="loading" class="loading">
  <div class="loading-spinner"></div>
  <p>Processing file...</p>
</div>

<!-- Statistics container -->
<div id="statsContainer" class="stats-container" style="display:none;">
  <div class="stat-box">
    <div class="stat-title">Total Rows Processed</div>
    <div id="totalRows" class="stat-value">0</div>
  </div>
  <div class="stat-box">
    <div class="stat-title">DUT Mappings</div>
    <div id="dutMappings" class="stat-value">0</div>
  </div>
  <div class="stat-box">
    <div class="stat-title">Security Roles</div>
    <div id="securityRoles" class="stat-value">0</div>
  </div>
  <div class="stat-box">
    <div class="stat-title">Validation Issues</div>
    <div id="validationIssues" class="stat-value">0</div>
  </div>
</div>

<!-- DUT file status -->
<div id="dutStatus" class="unit-status not-loaded">
  <strong>⚠ XXC_MPS_CONNECT_DEFAULTUNIT file Not Loaded</strong><br>
  Please upload the XXC_MPS_CONNECT_DEFAULTUNIT Excel file for work tray and rank validation.
  <div class="validation-info">
    <strong>Validation Rules:</strong><br>
    1. Work tray (from Column U in MBS file) must match Column D in DUT file<br>
    2. Rank/Grade must match Column E in DUT file<br>
    3. Both must be found in the <strong>same row</strong> in DUT file
  </div>
</div>

<!-- DUT file upload area -->
<div id="dutUploadArea" class="manual-upload-area">
  Drag & Drop or Click to Upload XXC_MPS_CONNECT_DEFAULTUNIT.xlsx
  <input type="file" id="dutFileInput" accept=".xlsx" style="display:none" />
</div>

<div id="uploadArea" class="upload-area">
Drag & Drop or Click to Upload MBS Excel file
<input type="file" id="fileInput" accept=".xlsx" style="display:none" />
</div>

<button id="processBtn">Process & Download Excel</button>
<button id="clearBtn" style="background:#666; margin-left:10px;">Clear All</button>

<div id="previewContainer" class="preview-section"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const uploadArea = document.getElementById("uploadArea");
    const fileInput = document.getElementById("fileInput");
    const previewContainer = document.getElementById("previewContainer");
    const processBtn = document.getElementById("processBtn");
    const clearBtn = document.getElementById("clearBtn");
    const loading = document.getElementById("loading");
    const statsContainer = document.getElementById("statsContainer");
    const totalRowsElement = document.getElementById("totalRows");
    const dutMappingsElement = document.getElementById("dutMappings");
    const securityRolesElement = document.getElementById("securityRoles");
    const validationIssuesElement = document.getElementById("validationIssues");
    const dutStatus = document.getElementById("dutStatus");
    const dutUploadArea = document.getElementById("dutUploadArea");
    const dutFileInput = document.getElementById("dutFileInput");
    
    let uploadedFile = null;
    let uploadedRows = [];
    let dutFileData = []; // Array to store DUT file rows
    let processing = false;
    
    // Show DUT file upload area
    dutUploadArea.style.display = "block";
    
    // VALID SECURITY ROLES LIST
    const VALID_SECURITY_ROLES = [
        "BOLT_ON_1", "BOLT_ON_2", "BOLT_ON_3", "BOLT_ON_4", "BOLT_ON_5", "BOLT_ON_6", "BOLT_ON_7", "BOLT_ON_8",
        "CONSTABLE", "SGT", "INSP", "C_INSP", "SUPT", "C_SUPT", "COMMDR", "DEP_ASS_COMMIS", "ASS_COMMIS", 
        "DEP_COMMIS", "COMMIS", "MSC_CONS", "MSC_SGT", "MSC_INSP", "MSC_CINSP", "MSC_ASS_CO", "MSC_CO",
        "SGT_CUST", "HCP", "HCP_FTAC", "CCC", "DDO", "PAO", "PCSO", "INVESTIGATOR", "SUP_INVESTIGATOR",
        "ANPR", "FCR", "FORENSICS", "INTEL", "INTEL_MANAGER", "INTEL_SIU", "INTEL_SOURCE", "INTEL_ENQUIRY_LOG",
        "PNCB", "PROPERTY", "PSD", "TDIU", "CMS", "DDM", "CMT", "CPA", "CASE_TRAFFIC", "CJOMS", "MET_INTERNAL",
        "VIEW_AND_SEARCH", "VIEW_ONLY", "MI", "MOPI", "FLAGS_C2S", "FLAGS_NDH", "FLAGS_NT", "FLAGS_VIEW_USERS",
        "SEALED_AUDIT", "NO_FIELD_SEC", "COVERT_ACCESS_FLAG", "FLAG_CLOSED_ACCESS", "FLAG_SECURE_ACCESS",
        "FLAG_TEAM", "SW_ALL_ACCESS", "PMP_ALL_ACCESS", "PMP_USER", "SYS_ADMIN", "SYSADMIN_FULL", "SYSADMIN_DQ1",
        "SYSADMIN_DQ2", "SYS_ADMIN_DQFULL", "FULL_SYS_ADMIN", "SYSADMIN_CST", "SYSADMIN_CST_FULL", "LOCKED_ADMIN",
        "SYSADMIN_NEC"
    ];
    
    // Initialize stats
    updateStats();
    
    // DUT file upload handlers
    dutUploadArea.addEventListener("click", () => dutFileInput.click());
    dutFileInput.addEventListener("change", e => {
        if(e.target.files[0]) handleDUTFile(e.target.files[0]);
    });
    
    // Main Excel file upload handlers
    uploadArea.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", e => {
        if(e.target.files[0] && !processing) handleFile(e.target.files[0]);
    });
    
    // Clear button handler
    clearBtn.addEventListener("click", () => {
        if (!processing) {
            resetApplication();
        }
    });
    
    function resetApplication() {
        uploadedFile = null;
        uploadedRows = [];
        dutFileData = [];
        uploadArea.textContent = "Drag & Drop or Click to Upload MBS Excel file";
        uploadArea.style.background = "white";
        dutUploadArea.textContent = "Drag & Drop or Click to Upload XXC_MPS_CONNECT_DEFAULTUNIT.xlsx";
        dutUploadArea.className = "manual-upload-area";
        dutUploadArea.style.display = "block";
        dutStatus.className = "unit-status not-loaded";
        dutStatus.innerHTML = `<strong>⚠ XXC_MPS_CONNECT_DEFAULTUNIT file Not Loaded</strong><br>
        Please upload the XXC_MPS_CONNECT_DEFAULTUNIT Excel file for work tray and rank validation.
        <div class="validation-info">
          <strong>Validation Rules:</strong><br>
          1. Work tray (from Column U in MBS file) must match Column D in DUT file<br>
          2. Rank/Grade must match Column E in DUT file<br>
          3. Both must be found in the <strong>same row</strong> in DUT file
        </div>`;
        previewContainer.innerHTML = "";
        processBtn.style.display = "none";
        clearBtn.style.display = "none";
        statsContainer.style.display = "none";
        fileInput.value = "";
        dutFileInput.value = "";
        updateStats();
    }
    
    function updateStats(dutCount = 0, secCount = 0, issueCount = 0) {
        totalRowsElement.textContent = uploadedRows.length;
        dutMappingsElement.textContent = dutCount;
        securityRolesElement.textContent = secCount;
        validationIssuesElement.textContent = issueCount;
        
        if (uploadedRows.length > 0) {
            statsContainer.style.display = "flex";
        }
    }
    
    function showLoading(show) {
        loading.style.display = show ? "block" : "none";
        processing = show;
        processBtn.disabled = show;
        clearBtn.disabled = show;
        
        if (show) {
            uploadArea.classList.add("processing");
            dutUploadArea.classList.add("processing");
        } else {
            uploadArea.classList.remove("processing");
            dutUploadArea.classList.remove("processing");
        }
    }
    
    function handleDUTFile(file) {
        if (!file.name.toLowerCase().endsWith('.xlsx')) {
            alert("Please upload an Excel (.xlsx) file.");
            return;
        }
        
        showLoading(true);
        dutUploadArea.textContent = `Loading ${file.name}...`;
        
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                dutFileData = XLSX.utils.sheet_to_json(sheet, { defval: "" });
                
                if (dutFileData.length === 0) {
                    alert("The DUT file appears to be empty.");
                    showLoading(false);
                    dutUploadArea.textContent = "Drag & Drop or Click to Upload XXC_MPS_CONNECT_DEFAULTUNIT.xlsx";
                    return;
                }
                
                // Create a map for quick lookup: key = worktray + "|" + rank
                const dutMap = new Map();
                let validPairs = 0;
                
                dutFileData.forEach((row, index) => {
                    const keys = Object.keys(row);
                    // Column D (index 3) is worktray, Column E (index 4) is rank/grade
                    const worktray = keys[3] && row[keys[3]] ? row[keys[3]].toString().trim().toUpperCase() : "";
                    const rank = keys[4] && row[keys[4]] ? row[keys[4]].toString().trim() : "";
                    
                    if (worktray && rank) {
                        const key = `${worktray}|${rank}`;
                        dutMap.set(key, { row: index + 2, worktray, rank }); // +2 for 1-indexed and header row
                        validPairs++;
                    }
                });
                
                dutFileData.dutMap = dutMap; // Store the map for later use
                
                dutStatus.className = "unit-status loaded";
                dutStatus.innerHTML = `<strong>✓ XXC_MPS_CONNECT_DEFAULTUNIT file Loaded</strong><br>
                Loaded ${dutFileData.length} rows with ${validPairs} valid worktray/rank pairs for validation.`;
                dutUploadArea.textContent = `DUT File Loaded: ${file.name}`;
                dutUploadArea.className = "manual-upload-area loaded";
                
                // If MBS file is already loaded, refresh preview
                if (uploadedRows.length > 0) {
                    renderPreview(uploadedRows);
                }
                
                showLoading(false);
                
            } catch (error) {
                alert("Error reading DUT file. Please make sure it's a valid Excel file.");
                console.error("DUT file parsing error:", error);
                showLoading(false);
                dutUploadArea.textContent = "Drag & Drop or Click to Upload XXC_MPS_CONNECT_DEFAULTUNIT.xlsx";
                dutUploadArea.className = "manual-upload-area";
            }
        };
        
        reader.onerror = () => {
            alert("Error reading the DUT file.");
            showLoading(false);
            dutUploadArea.textContent = "Drag & Drop or Click to Upload XXC_MPS_CONNECT_DEFAULTUNIT.xlsx";
            dutUploadArea.className = "manual-upload-area";
        };
        
        setTimeout(() => reader.readAsArrayBuffer(file), 100);
    }
    
    // Check if worktray/rank combination exists in DUT file
    function validateInDUTFile(worktray, rank) {
        if (!dutFileData.dutMap || !worktray || !rank) {
            return { exists: false, details: null };
        }
        
        const worktrayUpper = worktray.toUpperCase();
        
        // Generate all rank variations and check each one
        const rankVariations = generateRankVariations(rank);
        
        for (const variation of rankVariations) {
            const key = `${worktrayUpper}|${variation}`;
            if (dutFileData.dutMap.has(key)) {
                return { 
                    exists: true, 
                    details: dutFileData.dutMap.get(key),
                    matchedRank: variation
                };
            }
        }
        
        // Also try with the original rank (capitalized)
        const capitalizedRank = capitalizeRank(rank);
        if (capitalizedRank !== rankVariations[0]) {
            const key = `${worktrayUpper}|${capitalizedRank}`;
            if (dutFileData.dutMap.has(key)) {
                return { 
                    exists: true, 
                    details: dutFileData.dutMap.get(key),
                    matchedRank: capitalizedRank
                };
            }
        }
        
        return { exists: false, details: null };
    }

    function handleFile(file) {
        if (!file.name.toLowerCase().endsWith('.xlsx')) {
            alert("Please upload an Excel (.xlsx) file.");
            return;
        }
        
        showLoading(true);
        uploadArea.textContent = `Loading ${file.name}...`;
        uploadedFile = file;
        
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                uploadedRows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
                
                if (uploadedRows.length === 0) {
                    alert("The uploaded file appears to be empty.");
                    showLoading(false);
                    uploadArea.textContent = "Drag & Drop or Click to Upload MBS Excel file";
                    return;
                }
                
                uploadArea.textContent = `File Loaded: ${file.name} (${uploadedRows.length} rows)`;
                renderPreview(uploadedRows);
                processBtn.style.display = "inline-block";
                clearBtn.style.display = "inline-block";
                showLoading(false);
                
            } catch (error) {
                alert("Error reading Excel file. Please make sure it's a valid Excel file.");
                console.error(error);
                showLoading(false);
                uploadArea.textContent = "Drag & Drop or Click to Upload MBS Excel file";
            }
        };
        
        reader.onerror = () => {
            alert("Error reading the file.");
            showLoading(false);
            uploadArea.textContent = "Drag & Drop or Click to Upload MBS Excel file";
        };
        
        setTimeout(() => reader.readAsArrayBuffer(file), 100);
    }

    // Helper functions to get column values
    function getColumnValue(row, index) {
        const keys = Object.keys(row);
        return keys[index] && row[keys[index]] ? row[keys[index]].toString().trim() : "";
    }
    
    function getRankBand(row) {
        return getColumnValue(row, 7);
    }
    
    function getDUTAccess(row) {
        return getColumnValue(row, 18).toLowerCase();
    }
    
    function getWorkTrayName(row) {
        return getColumnValue(row, 20);
    }
    
    function getSecurityRole(row) {
        return getColumnValue(row, 21);
    }
    
    function getHighestOrgLevel(row) {
        const levels = ["Level 8 Sub-Team","Level 7 Team","Level 6 Function","Level 5 Portfolio","Level 4 Organisation"];
        for (let lvl of levels) {
            if (row[lvl] && row[lvl].toString().trim() !== "") return row[lvl].toString().trim();
        }
        return "";
    }

    function capitalizeRank(rank) {
        if (!rank) return "";
        
        if (rank.includes('-')) {
            return rank.split('-').map(part => capitalizeFirstLetter(part.trim())).join(' - ');
        }
        
        if (rank.toLowerCase().includes('msc')) {
            return rank.toUpperCase();
        }
        
        return rank.split(' ').map(word => {
            const smallWords = ['to', 'and', 'or', 'the', 'a', 'an', 'in', 'on', 'at', 'for', 'of'];
            if (smallWords.includes(word.toLowerCase())) {
                return word.toLowerCase();
            }
            if (word.toUpperCase() === 'UKFPU') {
                return 'UKFPU';
            }
            if (/^[a-z]$/i.test(word) || /^[1-8]$/.test(word)) {
                return word.toUpperCase();
            }
            return capitalizeFirstLetter(word);
        }).join(' ');
    }

    function capitalizeFirstLetter(str) {
        return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
    }

    function generateRankVariations(rank) {
        if (!rank) return [""];
        
        const rankLower = rank.toLowerCase().trim();
        const variations = [];
        
        if (rankLower.includes("msc") && rankLower.includes("special")) {
            const rankPart = rank.replace(/msc\s*special\s*/i, '').trim();
            variations.push(`Special ${rankPart}`);
            return variations;
        }
        
        // Constable variations
        if (rankLower.includes("constable") || rankLower === "cons") {
            variations.push("Constable");
            variations.push("Constable - PEQF");
            variations.push("Detective Constable");
            variations.push("Detective Constable - PEQF");
            variations.push("New Constable");
            variations.push("New Detective Constable");
        }
        // Sergeant variations
        else if (rankLower.includes("sergeant") || rankLower === "sgt") {
            variations.push("Sergeant");
            variations.push("Detective Sergeant");
        }
        // Inspector variations
        else if (rankLower.includes("inspector") || rankLower === "insp") {
            variations.push("Inspector");
            variations.push("Detective Inspector");
        }
        // Chief Inspector
        else if (rankLower.includes("chief inspector") || rankLower === "c_insp") {
            variations.push("Chief Inspector");
            variations.push("Detective Chief Inspector");
        }
        // Superintendent variations
        else if (rankLower.includes("superintendent") || rankLower === "supt") {
            variations.push("Superintendent");
            variations.push("Detective Superintendent");
            variations.push("New Superintendent");
        }
        // Chief Superintendent
        else if (rankLower.includes("chief superintendent") || rankLower === "c_supt") {
            variations.push("Chief Superintendent");
            variations.push("Detective Chief Superintendent");
        }
        // Commander
        else if (rankLower.includes("commander") || rankLower === "commdr") {
            variations.push("Commander");
        }
        // Assistant Commissioner
        else if (rankLower.includes("assistant commissioner")) {
            variations.push("Assistant Commissioner");
        }
        // Deputy Assistant Commissioner
        else if (rankLower.includes("deputy assistant commissioner") || rankLower.includes("deputy asst commissioner")) {
            variations.push("Deputy Assistant Commissioner");
        }
        // Commissioner
        else if (rankLower.includes("commissioner")) {
            variations.push("Commissioner");
        }
        // For all other specific ranks listed, just return as-is
        else if (rankLower.match(/^(advisor to management board|assistant commissioner|bb1|bb2|bb3|cbss1|fleet - manager|fleet - team member|ffs|intern|mass m2|mass p2|mass s4|mopac advisor|mopac apprentice|mopac band b|mopac grade [1-8]|mopac smt|non executive director|non exec director|norfolk [c-g]|norfolk hydrant|norfolk i|ukfpu - [67]|ukfpu - eo|ukfpu - heo|ukfpu - seo|volunteer|tupe interim)$/i)) {
            variations.push(capitalizeRank(rank));
        }
        // For Band ranks (Band A, Band B, Band K1, etc.)
        else if (/^band\s+[a-z0-9]/i.test(rankLower)) {
            variations.push(capitalizeRank(rank));
        }
        // For Unbanded
        else if (/^unbanded$/i.test(rankLower)) {
            variations.push("Unbanded");
        }
        // For any other rank not specifically handled
        else {
            variations.push(capitalizeRank(rank));
        }
        
        return variations;
    }

    function isOfficerRank(rank) {
        if (!rank) return false;
        const rankLower = rank.toLowerCase();
        
        const isBand = /^band\s+[a-z0-9]/i.test(rankLower);
        const isUnbanded = /^unbanded$/i.test(rankLower);
        
        const staffRoles = [
            'band a', 'band b', 'band c', 'band d', 'band e', 'band f', 'band g', 
            'band y', 'band o', 'band t', 'band x', 'band k1', 'band w', 'band i', 
            'band k2', 'band n', 'band p1', 'band p2', 'band j1', 'band j2', 
            'band j3', 'band j4', 'band s1', 'band s', 'band m', 'band r transport', 
            'band r dp', 'band v', 'band j', 'band l', 'band u', 'band h',
            'advisor to management board',
            'bb1', 'bb2', 'bb3',
            'cbss1',
            'fleet - manager', 'fleet - team member',
            'ffs',
            'intern',
            'mass m2', 'mass p2', 'mass s4',
            'mopac advisor', 'mopac apprentice', 'mopac band b',
            'mopac grade 1', 'mopac grade 2', 'mopac grade 3', 'mopac grade 4',
            'mopac grade 5', 'mopac grade 6', 'mopac grade 7', 'mopac grade 8',
            'mopac smt',
            'non executive director', 'non exec director',
            'norfolk c', 'norfolk d', 'norfolk e', 'norfolk f', 'norfolk g',
            'norfolk hydrant', 'norfolk i',
            'ukfpu - 6', 'ukfpu - 7', 'ukfpu - eo', 'ukfpu - heo', 'ukfpu - seo',
            'volunteer', 'tupe interim'
        ];
        
        const isStaffRole = staffRoles.some(role => rankLower.includes(role));
        
        const officerRankPatterns = [
            /constable/i,
            /sergeant/i,
            /inspector/i,
            /commissioner/i,
            /chief inspector/i,
            /commander/i,
            /superintendent/i,
            /chief superintendent/i,
            /deputy assistant commissioner/i,
            /c_insp/i,
            /c_supt/i,
            /commdr/i,
            /supt/i,
            /insp/i,
            /sgt/i,
            /cons/i
        ];
        
        const isOfficer = officerRankPatterns.some(pattern => pattern.test(rankLower));
        
        return isOfficer && !isBand && !isUnbanded && !isStaffRole;
    }
    
    function isStaffRank(rank) {
        if (!rank) return false;
        const rankLower = rank.toLowerCase();
        
        const isBand = /^band\s+[a-z0-9]/i.test(rankLower);
        const isUnbanded = /^unbanded$/i.test(rankLower);
        
        const staffRoles = [
            'band a', 'band b', 'band c', 'band d', 'band e', 'band f', 'band g', 
            'band y', 'band o', 'band t', 'band x', 'band k1', 'band w', 'band i', 
            'band k2', 'band n', 'band p1', 'band p2', 'band j1', 'band j2', 
            'band j3', 'band j4', 'band s1', 'band s', 'band m', 'band r transport', 
            'band r dp', 'band v', 'band j', 'band l', 'band u', 'band h',
            'advisor to management board',
            'bb1', 'bb2', 'bb3',
            'cbss1',
            'fleet - manager', 'fleet - team member',
            'ffs',
            'intern',
            'mass m2', 'mass p2', 'mass s4',
            'mopac advisor', 'mopac apprentice', 'mopac band b',
            'mopac grade 1', 'mopac grade 2', 'mopac grade 3', 'mopac grade 4',
            'mopac grade 5', 'mopac grade 6', 'mopac grade 7', 'mopac grade 8',
            'mopac smt',
            'non executive director', 'non exec director',
            'norfolk c', 'norfolk d', 'norfolk e', 'norfolk f', 'norfolk g',
            'norfolk hydrant', 'norfolk i',
            'ukfpu - 6', 'ukfpu - 7', 'ukfpu - eo', 'ukfpu - heo', 'ukfpu - seo',
            'volunteer', 'tupe interim'
        ];
        
        const isStaffRole = staffRoles.some(role => rankLower.includes(role));
        
        return isBand || isUnbanded || isStaffRole;
    }

    function validateSecurityRole(role) {
        if (!role) return { isValid: false, formatted: "INVALID SECURITY ROLE" };
        
        const roleUpper = role.toUpperCase().replace(/\s+/g, '_');
        
        if (VALID_SECURITY_ROLES.includes(roleUpper)) {
            return { isValid: true, formatted: roleUpper };
        }
        
        const roleNoUnderscore = roleUpper.replace(/_/g, '');
        for (const validRole of VALID_SECURITY_ROLES) {
            if (validRole.replace(/_/g, '') === roleNoUnderscore) {
                return { isValid: true, formatted: validRole };
            }
        }
        
        return { isValid: false, formatted: "INVALID SECURITY ROLE" };
    }

    // Determine description with DUT file validation
    function getDescription(row) {
        const rank = getRankBand(row);
        const dutAccess = getDUTAccess(row);
        const workTray = getWorkTrayName(row);
        const securityRole = getSecurityRole(row);
        
        // Check 1: Officer rank with Access = No
        if (isOfficerRank(rank) && dutAccess === "no") {
            return { 
                text: "Officer rank will have access, access is set to No", 
                color: "#ffcccc",
                issue: true,
                validation: { valid: false, reason: "Officer rank should have access" }
            };
        }
        
        // Check 2: Staff role with Access = Yes but no security role
        if (isStaffRank(rank) && dutAccess === "yes" && workTray && !securityRole) {
            return { 
                text: "Staff roles require a security role to have connect access", 
                color: "#ffcccc",
                issue: true,
                validation: { valid: false, reason: "Missing security role for staff" }
            };
        }
        
        // Normal work tray display
        if (dutAccess === "no") {
            return { 
                text: "NO ACCESS", 
                color: "", 
                issue: false,
                validation: { valid: true, reason: "No access required" }
            };
        } else if (dutAccess === "yes" && !workTray) {
            return { 
                text: "Require work tray name", 
                color: "#ffcccc", 
                issue: true,
                validation: { valid: false, reason: "Missing work tray name" }
            };
        } else if (workTray) {
            // Validate against DUT file
            const dutValidation = validateInDUTFile(workTray, rank);
            
            if (dutValidation.exists) {
                return { 
                    text: workTray.toUpperCase(), 
                    color: "#ccffcc", 
                    issue: false,
                    validation: { 
                        valid: true, 
                        reason: `Found in DUT file (row ${dutValidation.details.row})`,
                        details: dutValidation
                    }
                };
            } else {
                return { 
                    text: workTray.toUpperCase(), 
                    color: "#ffcccc", 
                    issue: true,
                    validation: { 
                        valid: false, 
                        reason: "Not found in DUT file",
                        details: dutValidation
                    }
                };
            }
        }
        
        return { 
            text: "NO ACCESS", 
            color: "", 
            issue: false,
            validation: { valid: true, reason: "No access required" }
        };
    }

    function renderPreview(rows) {
        const dutHeaders = ["Lookup type","Code","Meaning","Description","PSOP Grade","From","To","Enabled","Context Value","PSOP Organisation"];
        let dutHTML = `<h2>DUT Mapping Preview</h2>`;
        
        if (dutFileData.dutMap) {
            dutHTML += `<div class="validation-info">Validating against DUT file: ${dutFileData.dutMap.size} worktray/rank combinations loaded</div>`;
        }
        
        dutHTML += `<table><thead><tr>${dutHeaders.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>`;
        
        const secHeaders = ["Lookup Type","Code","Meaning","Description","From","To","Enabled","Context Value","PSOP Organisation","PSOP Grade"];
        let secHTML = `<h2>Security Roles Preview</h2><table><thead><tr>${secHeaders.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>`;
        
        let dutCount = 0;
        let secCount = 0;
        let issueCount = 0;
        let hasSecurityRows = false;
        
        rows.forEach((row, rowIndex) => {
            const rank = getRankBand(row);
            const dutAccess = getDUTAccess(row);
            const workTray = getWorkTrayName(row);
            const securityRole = getSecurityRole(row);
            const orgLevel = getHighestOrgLevel(row);
            
            const description = getDescription(row);
            if (description.issue) issueCount++;
            
            const rankVariations = generateRankVariations(rank);
            const securityValidation = validateSecurityRole(securityRole);
            if (!securityValidation.isValid && securityRole) issueCount++;
            
            // Create DUT rows for each variation
            rankVariations.forEach(variation => {
                dutCount++;
                let tooltip = "";
                if (description.validation && description.validation.details) {
                    if (description.validation.valid) {
                        tooltip = ` title="✓ Valid: ${description.validation.reason}"`;
                    } else {
                        tooltip = ` title="✗ Invalid: ${description.validation.reason}"`;
                    }
                }
                
                const rowClass = description.issue ? 'error-row' : description.color === '#ccffcc' ? 'success-row' : '';
                dutHTML += `<tr class="${rowClass}"${tooltip}>`;
                dutHTML += `<td>XXC_MPS_CONNECT_DEFAULTUNIT</td>`;
                dutHTML += `<td></td>`;
                dutHTML += `<td></td>`;
                dutHTML += `<td style="background-color: ${description.color}">${description.text}</td>`;
                dutHTML += `<td>${variation}</td>`;
                dutHTML += `<td></td>`;
                dutHTML += `<td></td>`;
                dutHTML += `<td>Y</td>`;
                dutHTML += `<td>XXC_CONNECT_ORG_AND_GRADE</td>`;
                dutHTML += `<td>${orgLevel}</td>`;
                dutHTML += `</tr>`;
            });
            
            // Create Security rows
            if (securityRole) {
                hasSecurityRows = true;
                rankVariations.forEach(variation => {
                    secCount++;
                    const secRowClass = !securityValidation.isValid ? 'error-row' : '';
                    const secTooltip = !securityValidation.isValid ? ' title="Invalid security role"' : '';
                    secHTML += `<tr class="${secRowClass}"${secTooltip}>`;
                    secHTML += `<td>XXC_MPS_CONNECT_RANK_ORG</td>`;
                    secHTML += `<td></td>`;
                    secHTML += `<td></td>`;
                    secHTML += `<td style="background-color: ${!securityValidation.isValid ? '#ffcccc' : ''}">${securityValidation.formatted}</td>`;
                    secHTML += `<td></td>`;
                    secHTML += `<td></td>`;
                    secHTML += `<td>Y</td>`;
                    secHTML += `<td>XXC_CONNECT_ORG_AND_GRADE</td>`;
                    secHTML += `<td>${orgLevel}</td>`;
                    secHTML += `<td>${variation}</td>`;
                    secHTML += `</tr>`;
                });
            }
        });
        
        dutHTML += `</tbody></table><div class="row-count">Total DUT mappings: ${dutCount}</div>`;
        secHTML += `</tbody></table><div class="row-count">Total security roles: ${secCount}</div>`;
        
        let html = dutHTML;
        if (hasSecurityRows) {
            html += secHTML;
        }
        
        previewContainer.innerHTML = html;
        updateStats(dutCount, secCount, issueCount);
    }

    processBtn.addEventListener("click", () => {
        if(!uploadedFile || uploadedRows.length===0){ 
            alert("Please upload a file first."); 
            return; 
        }
        
        showLoading(true);
        
        // Process in chunks to avoid blocking UI
        setTimeout(() => {
            try {
                const dutHeaders = ["Lookup type","Code","Meaning","Description","PSOP Grade","From","To","Enabled","Context Value","PSOP Organisation"];
                const dutData = [dutHeaders];
                
                const secHeaders = ["Lookup Type","Code","Meaning","Description","From","To","Enabled","Context Value","PSOP Organisation","PSOP Grade"];
                const secData = [secHeaders];
                
                let dutCount = 0;
                let secCount = 0;
                
                uploadedRows.forEach(row => {
                    const rank = getRankBand(row);
                    const dutAccess = getDUTAccess(row);
                    const workTray = getWorkTrayName(row);
                    const securityRole = getSecurityRole(row);
                    const orgLevel = getHighestOrgLevel(row);
                    
                    const description = getDescription(row);
                    const rankVariations = generateRankVariations(rank);
                    const securityValidation = validateSecurityRole(securityRole);
                    
                    // Create DUT rows for each variation
                    rankVariations.forEach(variation => {
                        dutCount++;
                        dutData.push([
                            "XXC_MPS_CONNECT_DEFAULTUNIT", "", "", description.text, variation, "", "", "Y", "XXC_CONNECT_ORG_AND_GRADE", orgLevel
                        ]);
                    });
                    
                    // Create Security rows for each variation if security role exists
                    if (securityRole) {
                        rankVariations.forEach(variation => {
                            secCount++;
                            secData.push([
                                "XXC_MPS_CONNECT_RANK_ORG", "", "", securityValidation.formatted, "", "", "Y", "XXC_CONNECT_ORG_AND_GRADE", orgLevel, variation
                            ]);
                        });
                    }
                });
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(dutData), "DUT Mapping");
                if (secData.length > 1) {
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(secData), "Security Roles");
                }
                
                const timestamp = new Date().toISOString().slice(0,19).replace(/[:]/g,'-');
                const fileName = `PSOP_Connect_${timestamp}.xlsx`;
                
                XLSX.writeFile(wb, fileName);
                
                showLoading(false);
                
                // Show success message
                alert(`File processed successfully!\n\nGenerated: ${fileName}\n- DUT Mappings: ${dutCount}\n- Security Roles: ${secCount}`);
                
            } catch (error) {
                alert("Error processing file: " + error.message);
                console.error(error);
                showLoading(false);
            }
        }, 100);
    });

    // Add drag and drop for main Excel file
    uploadArea.addEventListener("dragover", e => { 
        e.preventDefault(); 
        uploadArea.style.background="#e6f2e6"; 
    });
    
    uploadArea.addEventListener("dragleave", () => { 
        uploadArea.style.background="white"; 
    });
    
    uploadArea.addEventListener("drop", e => { 
        e.preventDefault(); 
        uploadArea.style.background="white"; 
        if(e.dataTransfer.files && e.dataTransfer.files.length && !processing) {
            handleFile(e.dataTransfer.files[0]); 
        }
    });

    // Add drag and drop for DUT file
    dutUploadArea.addEventListener("dragover", e => { 
        e.preventDefault(); 
        dutUploadArea.style.background="#fff9e6"; 
    });
    
    dutUploadArea.addEventListener("dragleave", () => { 
        dutUploadArea.style.background="white"; 
    });
    
    dutUploadArea.addEventListener("drop", e => { 
        e.preventDefault(); 
        dutUploadArea.style.background="white"; 
        if(e.dataTransfer.files && e.dataTransfer.files.length && !processing) {
            handleDUTFile(e.dataTransfer.files[0]); 
        }
    });
});
</script>
</body>
</html>
