<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>PSOP Connect - Excel Transformer with Preview</title>
<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
<style>
body{font-family:Calibri, sans-serif;background:#f5f5f5;margin:0;padding:20px;color:#222}
.container{max-width:1200px;margin:0 auto}
h1{font-size:22px;margin-bottom:20px}
.upload-area{border:2px dashed #217346;padding:40px;text-align:center;background:white;border-radius:6px;color:#217346;cursor:pointer;font-weight:bold;margin-bottom:20px}
.upload-area:hover{background:#e6f2e6}
button{padding:10px 14px;border:none;border-radius:4px;background:#217346;color:#fff;cursor:pointer;font-size:16px;margin-bottom:20px;display:none;}
button:hover{background:#1a5a2f}
table{border-collapse:collapse;margin-top:20px;width:100%;font-family:Calibri,sans-serif;font-size:14px;table-layout:fixed}
th,td{border:1px solid #999;padding:6px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;text-align:left}
th{background:#217346;color:#fff;font-weight:bold;text-align:center}
.preview-section{margin-top:30px}
</style>
</head>
<body>
<div class="container">
  <h1>MBS - DUT & Security Mapping tool</h1>

  <h3>Known errors and how to fix them.</h3>
  <p><b>Nothing happens when I drag and drop my file:</b> sometimes when you drag and drop it does not work. The best thing to do is reload the page and instead of drag and dropping click on the "Drag &amp; Drop or Click to Upload Excel file" and select the file from your folders instead.</p>
  <p><b>It has put the incorrect security mapping:</b> you are still required to look and audit the mappings yourself which is why a preview of what you're going to download is shown. If someone has filled in the sheet wrong in MBS, this tool cannot edit the data; it only shows and formats the data the Excel file has.</p>
  <p><b>It is missing parts or all of the mapping:</b> this tool cannot edit mappingâ€”only format it from the file that is downloaded from MBS. The issue probably isn't the tool but the person who filled in the MBS file.</p>
<h3 style=color:red;>This is just a tool for mapping; it does not give authority for security roles.</h3>
<div id="uploadArea" class="upload-area">
Drag & Drop or Click to Upload MBS Excel file
<input type="file" id="fileInput" accept=".xlsx" style="display:none" />
</div>

<button id="processBtn">Process & Download Excel</button>

<div id="previewContainer" class="preview-section"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const uploadArea = document.getElementById("uploadArea");
    const fileInput = document.getElementById("fileInput");
    const previewContainer = document.getElementById("previewContainer");
    const processBtn = document.getElementById("processBtn");
    let uploadedFile = null;
    let uploadedRows = [];

    // Upload handlers
    uploadArea.addEventListener("click", () => fileInput.click());
    uploadArea.addEventListener("dragover", e => { e.preventDefault(); uploadArea.style.background="#e6f2e6"; });
    uploadArea.addEventListener("dragleave", () => { uploadArea.style.background="white"; });
    uploadArea.addEventListener("drop", e => { 
        e.preventDefault(); 
        uploadArea.style.background="white"; 
        if(e.dataTransfer.files && e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); 
    });
    fileInput.addEventListener("change", e => handleFile(e.target.files[0]));

    function handleFile(file) {
        uploadedFile = file;
        uploadArea.textContent = `File Loaded: ${file.name}`;
        const reader = new FileReader();
        reader.onload = e => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            uploadedRows = XLSX.utils.sheet_to_json(sheet, { defval:"" });
            renderPreview(uploadedRows);
            processBtn.style.display = "inline-block"; // show download button
        };
        reader.readAsArrayBuffer(uploadedFile);
    }

    function getHighestNonEmptyLevel(row) {
        const levels = ["Level 8 Sub-Team","Level 7 Team","Level 6 Function","Level 5 Portfolio","Level 4 Organisation"];
        for (let lvl of levels) {
            if (row[lvl] && row[lvl].toString().trim() !== "") return row[lvl].toString().trim();
        }
        return "";
    }

    function determineWorkTrayName(row) {
        // Check column S (Connect DUT? or similar - assuming column name indicates DUT access)
        let dutAccess = "";
        
        // Try to find column S by index or by common names
        const columnNames = Object.keys(row);
        
        // Look for common DUT access column names
        const dutColumnCandidates = [
            "Connect DUT?", 
            "DUT Access", 
            "Access to DUT",
            "Column S",  // Fallback
            columnNames[18] // Assuming S is 19th column (0-indexed 18)
        ];
        
        for (const colName of dutColumnCandidates) {
            if (row.hasOwnProperty(colName) && row[colName] !== undefined) {
                dutAccess = row[colName].toString().trim().toLowerCase();
                break;
            }
        }
        
        // Get Work Tray Name
        let workTray = (row["Work Tray Name"] || "").toString().trim();
        
        // Logic based on requirements
        if (dutAccess === "no") {
            return "NO ACCESS";
        } else if (dutAccess === "yes" && !workTray) {
            return "Require work tray name";
        } else if (workTray) {
            return workTray.toUpperCase();
        } else {
            return "NO ACCESS"; // Default fallback
        }
    }

    function generateRankVariations(rank) {
        const rankLower = rank.toString().trim().toLowerCase();
        const variations = [];
        
        // Constable variations
        if (rankLower.includes("constable") || rankLower === "cons") {
            variations.push("Constable");
            variations.push("Constable - PEQF");
            variations.push("Detective Constable");
            variations.push("New Constable");
            variations.push("New Detective Constable");
        }
        // Sergeant variations
        else if (rankLower.includes("sergeant") || rankLower === "sgt") {
            variations.push("Sergeant");
            variations.push("Detective Sergeant");
        }
        // Inspector variations
        else if (rankLower.includes("inspector") || rankLower === "insp") {
            variations.push("Inspector");
            variations.push("Detective Inspector");
        }
        
        return variations;
    }

    function getGradeMessage(grade) {
        const psopGrade = grade.toString().trim();
        
        // Check if grade contains "Band" followed by a space and a letter
        const bandPattern = /^Band\s+[A-Za-z]$/i;
        
        if (psopGrade && !bandPattern.test(psopGrade)) {
            return "Officer role will have access";
        }
        
        return psopGrade;
    }

    function generateExcelData(rows) {
        const dutHeaders = ["Lookup type","Code","Meaning","Description","PSOP Grade","From","To","Enabled","Context Value","PSOP Organisation"];
        const dutData = [dutHeaders];

        const secHeaders = ["Lookup Type","Code","Meaning","Description","From","To","Enabled","Context Value","PSOP Organisation","PSOP Grade"];
        const secData = [secHeaders];

        let hasSecurity = false;

        rows.forEach((r,i) => {
            // Determine Work Tray Name based on new logic
            const workTray = determineWorkTrayName(r);
            
            // Get PSOP Grade with special handling
            const rawGrade = (r["Rank/Band"] || "").toString();
            const psopGrade = getGradeMessage(rawGrade);
            
            // Get rank variations if applicable
            const rankVariations = generateRankVariations(rawGrade);
            
            // Trim highest org
            const psopOrg = getHighestNonEmptyLevel(r);

            // If we have rank variations, create multiple rows
            if (rankVariations.length > 0) {
                // Create DUT and Security rows for each rank variation
                rankVariations.forEach(variation => {
                    // DUT Mapping row for this variation
                    dutData.push([
                        "XXC_MPS_CONNECT_DEFAULTUNIT","", "", workTray, variation, "", "", "Y", "XXC_CONNECT_ORG_AND_GRADE", psopOrg
                    ]);

                    // Security Role row for this variation
                    let roleRaw = (r["Connect Security Role"] || "").toString().trim();
                    if(roleRaw){
                        hasSecurity = true;
                        const formattedRole = roleRaw.toUpperCase().replace(/\s+/g,"_");
                        secData.push([
                            "XXC_MPS_CONNECT_RANK_ORG","", "", formattedRole, "", "", "Y", "XXC_CONNECT_ORG_AND_GRADE", psopOrg, variation
                        ]);
                    }
                });
            } else {
                // Original single row logic
                // DUT Mapping row
                dutData.push([
                    "XXC_MPS_CONNECT_DEFAULTUNIT","", "", workTray, psopGrade, "", "", "Y", "XXC_CONNECT_ORG_AND_GRADE", psopOrg
                ]);

                // Security Role row
                let roleRaw = (r["Connect Security Role"] || "").toString().trim();
                if(roleRaw){
                    hasSecurity = true;
                    const formattedRole = roleRaw.toUpperCase().replace(/\s+/g,"_");
                    secData.push([
                        "XXC_MPS_CONNECT_RANK_ORG","", "", formattedRole, "", "", "Y", "XXC_CONNECT_ORG_AND_GRADE", psopOrg, psopGrade
                    ]);
                }
            }
        });

        return { dutData, secData, hasSecurity };
    }

    function renderPreview(rows) {
        const { dutData, secData, hasSecurity } = generateExcelData(rows);
        let html = `<h2>DUT Mapping Preview</h2><table><thead><tr>${dutData[0].map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>`;
        dutData.slice(1).forEach(row => { html+=`<tr>${row.map(c=>`<td>${c}</td>`).join('')}</tr>`; });
        html += `</tbody></table>`;

        if(hasSecurity){
            html += `<h2>Security Roles Preview</h2><table><thead><tr>${secData[0].map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>`;
            secData.slice(1).forEach(row => { html+=`<tr>${row.map(c=>`<td>${c}</td>`).join('')}</tr>`; });
            html += `</tbody></table>`;
        }

        previewContainer.innerHTML = html;
    }

    processBtn.addEventListener("click", () => {
        if(!uploadedFile || uploadedRows.length===0){ alert("Please upload a file first."); return; }
        const { dutData, secData, hasSecurity } = generateExcelData(uploadedRows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(dutData), "DUT Mapping");
        if(hasSecurity){
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(secData), "Security Roles");
        }
        const timestamp = new Date().toISOString().slice(0,19).replace(/[:]/g,'-');
        XLSX.writeFile(wb, `PSOP_Connect_${timestamp}.xlsx`);
    });

});
</script>
</body>
</html>
