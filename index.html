<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>PSOP Connect - Excel Transformer with Preview</title>
<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
<style>
body{font-family:Calibri, sans-serif;background:#f5f5f5;margin:0;padding:20px;color:#222}
.container{max-width:1200px;margin:0 auto}
h1{font-size:22px;margin-bottom:20px}
.upload-area{border:2px dashed #217346;padding:40px;text-align:center;background:white;border-radius:6px;color:#217346;cursor:pointer;font-weight:bold;margin-bottom:20px}
.upload-area:hover{background:#e6f2e6}
button{padding:10px 14px;border:none;border-radius:4px;background:#217346;color:#fff;cursor:pointer;font-size:16px;margin-bottom:20px;display:none;}
button:hover{background:#1a5a2f}
table{border-collapse:collapse;margin-top:20px;width:100%;font-family:Calibri,sans-serif;font-size:14px;table-layout:fixed}
th,td{border:1px solid #999;padding:6px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;text-align:left}
th{background:#217346;color:#fff;font-weight:bold;text-align:center}
.preview-section{margin-top:30px}
.unit-status {margin-bottom: 20px; padding: 10px; border-radius: 4px;}
.unit-status.loaded {background-color: #ccffcc; border: 1px solid #217346;}
.unit-status.not-loaded {background-color: #ffcccc; border: 1px solid #ff0000;}
.manual-upload-area {border: 2px dashed #ff9900; padding: 20px; text-align: center; background: white; border-radius: 6px; color: #ff9900; cursor: pointer; font-weight: bold; margin-bottom: 20px; display: none;}
.manual-upload-area:hover {background: #fff9e6;}
</style>
</head>
<body>
<div class="container">
  <h1>MBS - DUT & Security Mapping tool</h1>

<!-- Unit.csv status will be inserted here -->
<div id="unitStatus" class="unit-status not-loaded">
  <strong>⚠ Unit.csv Not Loaded</strong><br>
  Please upload the Unit.csv file for work tray validation.
</div>

<!-- Manual Unit.csv upload area -->
<div id="unitUploadArea" class="manual-upload-area">
  Drag & Drop or Click to Upload Unit.csv file
  <input type="file" id="unitFileInput" accept=".csv" style="display:none" />
</div>

<div id="uploadArea" class="upload-area">
Drag & Drop or Click to Upload MBS Excel file
<input type="file" id="fileInput" accept=".xlsx" style="display:none" />
</div>

<button id="processBtn">Process & Download Excel</button>

<div id="previewContainer" class="preview-section"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const uploadArea = document.getElementById("uploadArea");
    const fileInput = document.getElementById("fileInput");
    const previewContainer = document.getElementById("previewContainer");
    const processBtn = document.getElementById("processBtn");
    const unitStatus = document.getElementById("unitStatus");
    const unitUploadArea = document.getElementById("unitUploadArea");
    const unitFileInput = document.getElementById("unitFileInput");
    let uploadedFile = null;
    let uploadedRows = [];
    let validUnits = new Set();
    
    // Show manual upload for Unit.csv
    unitUploadArea.style.display = "block";
    
    // VALID SECURITY ROLES LIST
    const VALID_SECURITY_ROLES = [
        "BOLT_ON_1", "BOLT_ON_2", "BOLT_ON_3", "BOLT_ON_4", "BOLT_ON_5", "BOLT_ON_6", "BOLT_ON_7", "BOLT_ON_8",
        "CONSTABLE", "SGT", "INSP", "C_INSP", "SUPT", "C_SUPT", "COMMDR", "DEP_ASS_COMMIS", "ASS_COMMIS", 
        "DEP_COMMIS", "COMMIS", "MSC_CONS", "MSC_SGT", "MSC_INSP", "MSC_CINSP", "MSC_ASS_CO", "MSC_CO",
        "SGT_CUST", "HCP", "HCP_FTAC", "CCC", "DDO", "PAO", "PCSO", "INVESTIGATOR", "SUP_INVESTIGATOR",
        "ANPR", "FCR", "FORENSICS", "INTEL", "INTEL_MANAGER", "INTEL_SIU", "INTEL_SOURCE", "INTEL_ENQUIRY_LOG",
        "PNCB", "PROPERTY", "PSD", "TDIU", "CMS", "DDM", "CMT", "CPA", "CASE_TRAFFIC", "CJOMS", "MET_INTERNAL",
        "VIEW_AND_SEARCH", "VIEW_ONLY", "MI", "MOPI", "FLAGS_C2S", "FLAGS_NDH", "FLAGS_NT", "FLAGS_VIEW_USERS",
        "SEALED_AUDIT", "NO_FIELD_SEC", "COVERT_ACCESS_FLAG", "FLAG_CLOSED_ACCESS", "FLAG_SECURE_ACCESS",
        "FLAG_TEAM", "SW_ALL_ACCESS", "PMP_ALL_ACCESS", "PMP_USER", "SYS_ADMIN", "SYSADMIN_FULL", "SYSADMIN_DQ1",
        "SYSADMIN_DQ2", "SYS_ADMIN_DQFULL", "FULL_SYS_ADMIN", "SYSADMIN_CST", "SYSADMIN_CST_FULL", "LOCKED_ADMIN",
        "SYSADMIN_NEC"
    ];
    
    // Unit.csv upload handlers
    unitUploadArea.addEventListener("click", () => unitFileInput.click());
    unitFileInput.addEventListener("change", e => {
        if(e.target.files[0]) handleUnitFile(e.target.files[0]);
    });
    
    // Main Excel file upload handlers
    uploadArea.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", e => {
        if(e.target.files[0]) handleFile(e.target.files[0]);
    });

    function handleUnitFile(file) {
        if (!file.name.toLowerCase().endsWith('.csv')) {
            alert("Please upload a CSV file.");
            return;
        }
        
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const lines = e.target.result.split('\n');
                validUnits.clear();
                
                lines.forEach(line => {
                    if (line.trim()) {
                        // Get first column (A)
                        const unit = line.split(',')[0].trim().toUpperCase();
                        if (unit) validUnits.add(unit);
                    }
                });
                
                unitStatus.className = "unit-status loaded";
                unitStatus.innerHTML = `<strong>✓ Unit.csv Loaded</strong><br>Loaded ${validUnits.size} valid units for work tray validation.`;
                unitUploadArea.textContent = `Unit.csv Loaded: ${file.name}`;
                unitUploadArea.style.borderColor = "#217346";
                unitUploadArea.style.color = "#217346";
                
                // If Excel is already loaded, refresh preview
                if (uploadedRows.length > 0) renderPreview(uploadedRows);
                
            } catch (error) {
                alert("Error reading Unit.csv file.");
                console.error(error);
            }
        };
        reader.readAsText(file);
    }

    function handleFile(file) {
        if (!file.name.toLowerCase().endsWith('.xlsx')) {
            alert("Please upload an Excel (.xlsx) file.");
            return;
        }
        
        uploadedFile = file;
        uploadArea.textContent = `File Loaded: ${file.name}`;
        
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                uploadedRows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
                renderPreview(uploadedRows);
                processBtn.style.display = "inline-block";
            } catch (error) {
                alert("Error reading Excel file. Please make sure it's a valid Excel file.");
                console.error(error);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // Helper functions to get column values
    function getColumnValue(row, index) {
        const keys = Object.keys(row);
        return keys[index] && row[keys[index]] ? row[keys[index]].toString().trim() : "";
    }
    
    function getRankBand(row) {
        // Column H (index 7)
        return getColumnValue(row, 7);
    }
    
    function getDUTAccess(row) {
        // Column S (index 18)
        return getColumnValue(row, 18).toLowerCase();
    }
    
    function getWorkTrayName(row) {
        // Column U (index 20)
        return getColumnValue(row, 20);
    }
    
    function getSecurityRole(row) {
        // Column V (index 21)
        return getColumnValue(row, 21);
    }
    
    function getHighestOrgLevel(row) {
        const levels = ["Level 8 Sub-Team","Level 7 Team","Level 6 Function","Level 5 Portfolio","Level 4 Organisation"];
        for (let lvl of levels) {
            if (row[lvl] && row[lvl].toString().trim() !== "") return row[lvl].toString().trim();
        }
        return "";
    }

    // Check if rank is officer (not Band X and not Unbanded)
    function isOfficerRank(rank) {
        if (!rank) return false;
        const rankLower = rank.toLowerCase();
        const isBand = /^band\s+[a-z]$/i.test(rankLower);
        const isUnbanded = /^unbanded$/i.test(rankLower);
        return !isBand && !isUnbanded;
    }
    
    // Check if rank is staff (Band X or Unbanded)
    function isStaffRank(rank) {
        if (!rank) return false;
        const rankLower = rank.toLowerCase();
        const isBand = /^band\s+[a-z]$/i.test(rankLower);
        const isUnbanded = /^unbanded$/i.test(rankLower);
        return isBand || isUnbanded;
    }

    // Generate rank variations
    function generateRankVariations(rank) {
        const rankLower = rank.toLowerCase();
        const variations = [];
        
        // Constable variations
        if (rankLower.includes("constable") || rankLower === "cons") {
            variations.push("Constable");
            variations.push("Constable - PEQF");
            variations.push("Detective Constable");
            variations.push("New Constable");
            variations.push("New Detective Constable");
        }
        // Sergeant variations
        else if (rankLower.includes("sergeant") || rankLower === "sgt") {
            variations.push("Sergeant");
            variations.push("Detective Sergeant");
        }
        // Inspector variations
        else if (rankLower.includes("inspector") || rankLower === "insp") {
            variations.push("Inspector");
            variations.push("Detective Inspector");
        }
        // For other ranks, just return the original
        else {
            variations.push(rank);
        }
        
        return variations;
    }

    // Validate security role
    function validateSecurityRole(role) {
        if (!role) return { isValid: false, formatted: "INVALID SECURITY ROLE" };
        
        const roleUpper = role.toUpperCase().replace(/\s+/g, '_');
        
        // Check against valid roles list
        if (VALID_SECURITY_ROLES.includes(roleUpper)) {
            return { isValid: true, formatted: roleUpper };
        }
        
        // Also check if it matches without underscores
        const roleNoUnderscore = roleUpper.replace(/_/g, '');
        for (const validRole of VALID_SECURITY_ROLES) {
            if (validRole.replace(/_/g, '') === roleNoUnderscore) {
                return { isValid: true, formatted: validRole };
            }
        }
        
        return { isValid: false, formatted: "INVALID SECURITY ROLE" };
    }

    // Determine description with validation
    function getDescription(row) {
        const rank = getRankBand(row);
        const dutAccess = getDUTAccess(row);
        const workTray = getWorkTrayName(row);
        const securityRole = getSecurityRole(row);
        
        // Check 1: Officer rank with Access = No
        if (isOfficerRank(rank) && dutAccess === "no") {
            return { 
                text: "Officer rank will have access, access is set to No", 
                color: "#ffcccc" 
            };
        }
        
        // Check 2: Officer rank with no work tray name
        if (isOfficerRank(rank) && !workTray) {
            return { 
                text: "Officer rank will have access, access is set to No", 
                color: "#ffcccc" 
            };
        }
        
        // Check 3: Staff role with Access = Yes but no security role
        if (isStaffRank(rank) && dutAccess === "yes" && workTray && !securityRole) {
            return { 
                text: "Staff roles require a security role to have connect access", 
                color: "#ffcccc" 
            };
        }
        
        // Normal work tray display
        if (dutAccess === "no") {
            return { text: "NO ACCESS", color: "" };
        } else if (dutAccess === "yes" && !workTray) {
            return { text: "Require work tray name", color: "" };
        } else if (workTray) {
            // Check if work tray exists in Unit.csv
            const workTrayUpper = workTray.toUpperCase();
            if (validUnits.size > 0) {
                if (validUnits.has(workTrayUpper)) {
                    return { text: workTrayUpper, color: "#ccffcc" };
                } else {
                    return { text: workTrayUpper, color: "#ffcccc" };
                }
            }
            return { text: workTrayUpper, color: "" };
        }
        
        return { text: "NO ACCESS", color: "" };
    }

    function renderPreview(rows) {
        const dutHeaders = ["Lookup type","Code","Meaning","Description","PSOP Grade","From","To","Enabled","Context Value","PSOP Organisation"];
        let dutHTML = `<h2>DUT Mapping Preview</h2><table><thead><tr>${dutHeaders.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>`;
        
        const secHeaders = ["Lookup Type","Code","Meaning","Description","From","To","Enabled","Context Value","PSOP Organisation","PSOP Grade"];
        let secHTML = `<h2>Security Roles Preview</h2><table><thead><tr>${secHeaders.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>`;
        
        let hasSecurityRows = false;
        
        rows.forEach((row, rowIndex) => {
            const rank = getRankBand(row);
            const dutAccess = getDUTAccess(row);
            const workTray = getWorkTrayName(row);
            const securityRole = getSecurityRole(row);
            const orgLevel = getHighestOrgLevel(row);
            
            // Get description with validation
            const description = getDescription(row);
            
            // Generate rank variations
            const rankVariations = generateRankVariations(rank);
            
            // Validate security role
            const securityValidation = validateSecurityRole(securityRole);
            const securityColor = securityValidation.isValid ? "" : "#ffcccc";
            
            // Create DUT rows for each variation
            rankVariations.forEach(variation => {
                dutHTML += `<tr>`;
                dutHTML += `<td>XXC_MPS_CONNECT_DEFAULTUNIT</td>`;
                dutHTML += `<td></td>`;
                dutHTML += `<td></td>`;
                dutHTML += `<td style="background-color: ${description.color}">${description.text}</td>`;
                dutHTML += `<td>${variation}</td>`;
                dutHTML += `<td></td>`;
                dutHTML += `<td></td>`;
                dutHTML += `<td>Y</td>`;
                dutHTML += `<td>XXC_CONNECT_ORG_AND_GRADE</td>`;
                dutHTML += `<td>${orgLevel}</td>`;
                dutHTML += `</tr>`;
            });
            
            // Create Security rows for each variation if security role exists
            if (securityRole) {
                hasSecurityRows = true;
                rankVariations.forEach(variation => {
                    secHTML += `<tr>`;
                    secHTML += `<td>XXC_MPS_CONNECT_RANK_ORG</td>`;
                    secHTML += `<td></td>`;
                    secHTML += `<td></td>`;
                    secHTML += `<td style="background-color: ${securityColor}">${securityValidation.formatted}</td>`;
                    secHTML += `<td></td>`;
                    secHTML += `<td></td>`;
                    secHTML += `<td>Y</td>`;
                    secHTML += `<td>XXC_CONNECT_ORG_AND_GRADE</td>`;
                    secHTML += `<td>${orgLevel}</td>`;
                    secHTML += `<td>${variation}</td>`;
                    secHTML += `</tr>`;
                });
            }
        });
        
        dutHTML += `</tbody></table>`;
        secHTML += `</tbody></table>`;
        
        let html = dutHTML;
        if (hasSecurityRows) {
            html += secHTML;
        }
        
        previewContainer.innerHTML = html;
    }

    processBtn.addEventListener("click", () => {
        if(!uploadedFile || uploadedRows.length===0){ 
            alert("Please upload a file first."); 
            return; 
        }
        
        const dutHeaders = ["Lookup type","Code","Meaning","Description","PSOP Grade","From","To","Enabled","Context Value","PSOP Organisation"];
        const dutData = [dutHeaders];
        
        const secHeaders = ["Lookup Type","Code","Meaning","Description","From","To","Enabled","Context Value","PSOP Organisation","PSOP Grade"];
        const secData = [secHeaders];
        
        uploadedRows.forEach(row => {
            const rank = getRankBand(row);
            const dutAccess = getDUTAccess(row);
            const workTray = getWorkTrayName(row);
            const securityRole = getSecurityRole(row);
            const orgLevel = getHighestOrgLevel(row);
            
            // Get description
            const description = getDescription(row);
            
            // Generate rank variations
            const rankVariations = generateRankVariations(rank);
            
            // Validate security role
            const securityValidation = validateSecurityRole(securityRole);
            
            // Create DUT rows for each variation
            rankVariations.forEach(variation => {
                dutData.push([
                    "XXC_MPS_CONNECT_DEFAULTUNIT", "", "", description.text, variation, "", "", "Y", "XXC_CONNECT_ORG_AND_GRADE", orgLevel
                ]);
            });
            
            // Create Security rows for each variation if security role exists
            if (securityRole) {
                rankVariations.forEach(variation => {
                    secData.push([
                        "XXC_MPS_CONNECT_RANK_ORG", "", "", securityValidation.formatted, "", "", "Y", "XXC_CONNECT_ORG_AND_GRADE", orgLevel, variation
                    ]);
                });
            }
        });
        
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(dutData), "DUT Mapping");
        if (secData.length > 1) {
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(secData), "Security Roles");
        }
        const timestamp = new Date().toISOString().slice(0,19).replace(/[:]/g,'-');
        XLSX.writeFile(wb, `PSOP_Connect_${timestamp}.xlsx`);
    });

    // Add drag and drop for main Excel file
    uploadArea.addEventListener("dragover", e => { 
        e.preventDefault(); 
        uploadArea.style.background="#e6f2e6"; 
    });
    
    uploadArea.addEventListener("dragleave", () => { 
        uploadArea.style.background="white"; 
    });
    
    uploadArea.addEventListener("drop", e => { 
        e.preventDefault(); 
        uploadArea.style.background="white"; 
        if(e.dataTransfer.files && e.dataTransfer.files.length) {
            handleFile(e.dataTransfer.files[0]); 
        }
    });

    // Add drag and drop for Unit.csv
    unitUploadArea.addEventListener("dragover", e => { 
        e.preventDefault(); 
        unitUploadArea.style.background="#fff9e6"; 
    });
    
    unitUploadArea.addEventListener("dragleave", () => { 
        unitUploadArea.style.background="white"; 
    });
    
    unitUploadArea.addEventListener("drop", e => { 
        e.preventDefault(); 
        unitUploadArea.style.background="white"; 
        if(e.dataTransfer.files && e.dataTransfer.files.length) {
            handleUnitFile(e.dataTransfer.files[0]); 
        }
    });
});
</script>
</body>
</html>
