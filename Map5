Sub ImportAllData()
    Dim ws1 As Worksheet, ws2 As Worksheet
    Dim lastRow As Long, i As Long, duRow As Long, hrRow As Long, col As Integer
    Dim needsDefault As Boolean, found As Boolean
    Dim orgLevel As String, unitToCheck As String
    Dim rolesFound As String, rankFound As String
    Dim defaultUnitQuery As ListObject, hrFeedQuery As ListObject
    Dim defaultUnitArray As Variant, hrFeedArray As Variant
    
    ' Set worksheets
    Set ws1 = ThisWorkbook.Sheets("Sheet1")
    Set ws2 = ThisWorkbook.Sheets("Sheet2")
    
    ' Error handling for query connections
    On Error Resume Next
    Set defaultUnitQuery = ThisWorkbook.Connections("DEFAULTUNIT_CHECK").Worksheet.ListObjects(1)
    Set hrFeedQuery = ThisWorkbook.Connections("HR_Feed").Worksheet.ListObjects(1)
    On Error GoTo 0
    
    ' Check if queries exist
    If defaultUnitQuery Is Nothing Then
        MsgBox "DEFAULTUNIT_CHECK query not found!", vbExclamation
        Exit Sub
    End If
    
    If hrFeedQuery Is Nothing Then
        MsgBox "HR_Feed query not found!", vbExclamation
        Exit Sub
    End If
    
    ' Load query data into arrays for faster processing
    defaultUnitArray = defaultUnitQuery.DataBodyRange.Value
    hrFeedArray = hrFeedQuery.DataBodyRange.Value
    
    Application.ScreenUpdating = False
    
    ' Find last row with data in Sheet2
    lastRow = ws2.Cells(ws2.Rows.Count, "A").End(xlUp).Row
    If lastRow < 2 Then lastRow = 2
    
    ' Clear previous data in target columns
    ws1.Range("D2:L" & lastRow).ClearContents
    
    ' Main processing loop
    For i = 2 To lastRow
        needsDefault = False
        rolesFound = ""
        rankFound = ""
        
        ' --- Original Import Logic ---
        ' Column D: R→S→T→U→V from Sheet2
        If ws2.Cells(i, 18).Value <> "" Then
            ws1.Cells(i, 4).Value = ws2.Cells(i, 18).Value
            needsDefault = True
        ElseIf ws2.Cells(i, 19).Value <> "" Then
            ws1.Cells(i, 4).Value = ws2.Cells(i, 19).Value
            needsDefault = True
        ElseIf ws2.Cells(i, 20).Value <> "" Then
            ws1.Cells(i, 4).Value = ws2.Cells(i, 20).Value
            needsDefault = True
        ElseIf ws2.Cells(i, 21).Value <> "" Then
            ws1.Cells(i, 4).Value = ws2.Cells(i, 21).Value
            needsDefault = True
        ElseIf ws2.Cells(i, 22).Value <> "" Then
            ws1.Cells(i, 4).Value = ws2.Cells(i, 22).Value
            needsDefault = True
        End If
        
        ' Column E: I from Sheet2
        ws1.Cells(i, 5).Value = ws2.Cells(i, 9).Value
        If ws1.Cells(i, 5).Value <> "" Then needsDefault = True
        
        ' Column J: H→G→F→E→D from Sheet2
        If ws2.Cells(i, 8).Value <> "" Then
            ws1.Cells(i, 10).Value = ws2.Cells(i, 8).Value
            needsDefault = True
        ElseIf ws2.Cells(i, 7).Value <> "" Then
            ws1.Cells(i, 10).Value = ws2.Cells(i, 7).Value
            needsDefault = True
        ElseIf ws2.Cells(i, 6).Value <> "" Then
            ws1.Cells(i, 10).Value = ws2.Cells(i, 6).Value
            needsDefault = True
        ElseIf ws2.Cells(i, 5).Value <> "" Then
            ws1.Cells(i, 10).Value = ws2.Cells(i, 5).Value
            needsDefault = True
        Else
            ws1.Cells(i, 10).Value = ws2.Cells(i, 4).Value
            If ws1.Cells(i, 10).Value <> "" Then needsDefault = True
        End If
        
        ' --- New DEFAULTUNIT_CHECK Logic ---
        unitToCheck = ws1.Cells(i, "J").Value
        found = False
        
        ' Search DEFAULTUNIT_CHECK
        If Not IsEmpty(unitToCheck) Then
            For duRow = LBound(defaultUnitArray, 1) To UBound(defaultUnitArray, 1)
                If defaultUnitArray(duRow, 1) = unitToCheck Then
                    orgLevel = defaultUnitArray(duRow, 11) ' Column K
                    found = True
                    Exit For
                End If
            Next duRow
        End If
        
        ' Search HR_Feed if found in DEFAULTUNIT_CHECK
        If found And Not IsEmpty(orgLevel) Then
            For hrRow = LBound(hrFeedArray, 1) To UBound(hrFeedArray, 1)
                For col = 1 To 10 ' Columns H-Q
                    If hrFeedArray(hrRow, col) = orgLevel Then
                        ' Get Security Roles (AG = column 33)
                        If Not IsEmpty(hrFeedArray(hrRow, 33)) Then
                            rolesFound = IIf(rolesFound = "", hrFeedArray(hrRow, 33), rolesFound & ", " & hrFeedArray(hrRow, 33))
                        End If
                        ' Get Rank (C = column 3)
                        If rankFound = "" And Not IsEmpty(hrFeedArray(hrRow, 3)) Then
                            rankFound = hrFeedArray(hrRow, 3)
                        End If
                        Exit For
                    End If
                Next col
            Next hrRow
        End If
        
        ' Set default values if needed
        If needsDefault Then
            ws1.Cells(i, 1).Value = "XXC_MPS_CONNECT_DEFAULTUNIT"
            ws1.Cells(i, 8).Value = "Y"
            ws1.Cells(i, 9).Value = "XXC_MPS_CONNECT_DEFAULTUNIT"
            ' Update K and L with roles and rank if found
            ws1.Cells(i, "K").Value = rolesFound
            ws1.Cells(i, "L").Value = rankFound
        Else
            ws1.Cells(i, 1).ClearContents
            ws1.Cells(i, 8).ClearContents
            ws1.Cells(i, 9).ClearContents
            ws1.Cells(i, "K").ClearContents
            ws1.Cells(i, "L").ClearContents
        End If
    Next i
    
    Application.ScreenUpdating = True
    MsgBox "Data import and processing completed successfully!" & vbCrLf & _
           "Processed " & (lastRow - 1) & " rows.", vbInformation
End Sub
